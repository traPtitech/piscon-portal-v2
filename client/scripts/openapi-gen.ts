import * as Bun from 'bun'
import * as yaml from 'yaml'

import openapiTS, { astToString } from 'openapi-typescript'

// openapi-typescript does not support the combination of oneOf and allOf.
// This is a workaround to strip the discriminator property from the schema.
// ref: https://openapi-ts.dev/advanced#use-oneof-by-itself

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const stripDiscriminator = (schema: any) => {
  Object.entries(schema).forEach(([key, value]) => {
    if (!(typeof value === 'object')) return
    if (key === 'discriminator') {
      delete schema[key]
    } else {
      stripDiscriminator(value)
    }
  })
}

const file = await Bun.file('../openapi/openapi.yml').text()
const parsed = yaml.parse(file)
stripDiscriminator(parsed)
const temp = Bun.env['FILE'] ?? '/tmp/openapi.yml'
await Bun.write(temp, yaml.stringify(parsed))

const ast = await openapiTS(new URL(temp, import.meta.url).toString())
const contents = astToString(ast)

const contentsWithHeader =
  `/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 */

` + contents

await Bun.write('./src/api/openapi.ts', contentsWithHeader)
